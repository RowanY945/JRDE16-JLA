name: Deploy Static Website to S3

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual triggering

# OIDC permissions for keyless authentication
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # No build step needed for this simple static website
    # Just update the deployment timestamp in the JavaScript file
    - name: Update deployment timestamp
      run: |
        echo "// Updating timestamp for deployment on $(date)" >> js/script.js
        echo "// Deployment ID: ${{ github.run_id }}" >> js/script.js

    # # Configure AWS credentials
    # - name: Configure AWS credentials
    #   uses: aws-actions/configure-aws-credentials@v1
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #     aws-region: "ap-south-1"

    # OIDC/IRSA Authentication - No more access keys!
    - name: Configure AWS credentials via OIDC
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: "arn:aws:iam::069717477771:role/JLA-GitHubOIDCRole"
        role-session-name: GitHubActions-Backend-${{ github.run_id }}
        aws-region: "ap-southeast-2"
  terraform-plan:
    runs-on: ubuntu-latest
    steps:
      - run: echo "Planning..."

  terraform-create:
    name: 'Terraform Apply to create'
    # 仅当代码推送到 main 分支时，才对 dev 环境运行 apply
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: terraform-plan # 依赖 plan 任务（虽然在 push 事件中 plan 不会运行，但这是好的实践）

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Apply to create
        working-directory: ./terraform/terraform_create_Natgateway # 硬编码 dev 目录
        run: |
          terraform init
          terraform apply -auto-approve


  terraform-delete:
    name: 'Terraform Apply to delete'
    # 仅当代码推送到 main 分支时运行
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest


    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Apply to delete
        working-directory: ./terraform/terraform_delete_Natgateway # 硬编码 prod 目录
        run: |
          terraform init
          terraform apply -auto-approve
